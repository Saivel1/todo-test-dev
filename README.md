# ToDo Bot - Telegram ะฑะพั ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะทะฐะดะฐัะฐะผะธ

ะะพะปะฝะพัะตะฝะฝะฐั ัะธััะตะผะฐ ัะฟัะฐะฒะปะตะฝะธั ะทะฐะดะฐัะฐะผะธ ั Django REST API backend ะธ Telegram ะฑะพัะพะผ ะฝะฐ Aiogram 3.

## ๐ฏ ะัะฝะพะฒะฝัะต ะฒะพะทะผะพะถะฝะพััะธ

### Backend (Django REST API)
- โ CRUD ะพะฟะตัะฐัะธะธ ะดะปั ะทะฐะดะฐั ะธ ะบะฐัะตะณะพัะธะน
- โ ะััะตะฝัะธัะธะบะฐัะธั ัะตัะตะท Telegram ID
- โ ะะฐััะพะผะฝัะต ULID Primary Keys (ะฑะตะท UUID/ะฐะฒัะพะธะฝะบัะตะผะตะฝัะฐ)
- โ Timezone-aware datetime (America/Adak)
- โ Celery ะดะปั ัะพะฝะพะฒัั ะทะฐะดะฐั
- โ ะะฒัะพะผะฐัะธัะตัะบะธะต ัะฒะตะดะพะผะปะตะฝะธั ะพ ะดะตะดะปะฐะนะฝะฐั
- โ REST API ั ัะพะบะตะฝ-ะฐััะตะฝัะธัะธะบะฐัะธะตะน
- โ Admin ะฟะฐะฝะตะปั Django

### Telegram Bot (Aiogram 3.x)
- ๐ค ะะตะณะธัััะฐัะธั ัะตัะตะท /start
- ๐ ะัะพัะผะพัั ะฒัะตั ะทะฐะดะฐั
- โ ะกะพะทะดะฐะฝะธะต ะทะฐะดะฐั ัะตัะตะท ะดะธะฐะปะพะณ (FSM)
- โ ะัะผะตัะบะฐ ะทะฐะดะฐั ะฒัะฟะพะปะฝะตะฝะฝัะผะธ
- ๐ ะฃะดะฐะปะตะฝะธะต ะทะฐะดะฐั
- ๐ท ะฃะฟัะฐะฒะปะตะฝะธะต ะบะฐัะตะณะพัะธัะผะธ
- โ๏ธ ะัะพัะผะพัั ะฟัะพััะพัะตะฝะฝัั ะทะฐะดะฐั
- โฐ ะฃะฒะตะดะพะผะปะตะฝะธั ะพ ะฟัะธะฑะปะธะถะฐััะธััั ะดะตะดะปะฐะนะฝะฐั

## ๐ ะััะธัะตะบัััะฐ
```
โโโโโโโโโโโโโโโโโโโ
โ  Telegram User  โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ
โ  Aiogram Bot    โโโโโโโถโ  Django API  โ
โ   (Python)      โ      โ  (REST)      โ
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโฌโโโโโโโโ
                                โ
                    โโโโโโโโโโโโโผโโโโโโโโโโโโ
                    โผ           โผ           โผ
            โโโโโโโโโโโโ  โโโโโโโโโโโ  โโโโโโโโโโโ
            โPostgreSQLโ  โ  Redis  โ  โ Celery  โ
            โโโโโโโโโโโโ  โโโโโโโโโโโ  โโโโโโโโโโโ
```

### ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั

1. **PostgreSQL** - ะัะฝะพะฒะฝะฐั ะฑะฐะทะฐ ะดะฐะฝะฝัั
2. **Redis** - ะัะพะบะตั ัะพะพะฑัะตะฝะธะน ะดะปั Celery
3. **Django Backend** - REST API ัะตัะฒะตั
4. **Celery Worker** - ะะฑัะฐะฑะพัะบะฐ ัะพะฝะพะฒัั ะทะฐะดะฐั
5. **Celery Beat** - ะะตัะธะพะดะธัะตัะบะธะต ะทะฐะดะฐัะธ (ะฟัะพะฒะตัะบะฐ ะดะตะดะปะฐะนะฝะพะฒ)
6. **Telegram Bot** - ะะฝัะตััะตะนั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

## ๐ ะขัะตะฑะพะฒะฐะฝะธั

- Docker & Docker Compose
- Python 3.13+ (ะดะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ)
- Telegram Bot Token (ะฟะพะปััะธัั ั [@BotFather](https://t.me/botfather))

## ๐ ะัััััะน ััะฐัั

### 1. ะะปะพะฝะธัะพะฒะฐะฝะธะต ัะตะฟะพะทะธัะพัะธั
```bash
git clone <repository-url>
cd todo-bot
```

### 2. ะะฐัััะพะนะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
```bash
# ะกะพะทะดะฐัั .env ัะฐะนะป ะธะท ะฟัะธะผะตัะฐ
cp .env.example .env

# ะััะตะดะฐะบัะธัะพะฒะฐัั .env ะธ ะดะพะฑะฐะฒะธัั ัะฒะพะน TELEGRAM_BOT_TOKEN
nano .env
```

### 3. ะะฐะฟััะบ ัะตัะตะท Docker Compose
```bash
# ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ ะฒัะตั ัะตัะฒะธัะพะฒ
docker compose build
docker compose up -d

# ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน
docker compose exec backend python manage.py migrate

# ะกะพะทะดะฐะฝะธะต ััะฟะตัะฟะพะปัะทะพะฒะฐัะตะปั (ะพะฟัะธะพะฝะฐะปัะฝะพ)
docker compose exec backend python manage.py createsuperuser

# ะะปะธ ะธัะฟะพะปัะทะพะฒะฐัั Makefile
make init  # ะะพะปะฝะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั ะฟัะพะตะบัะฐ
```

### 4. ะัะพะฒะตัะบะฐ ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััะธ
```bash
# ะัะพะฒะตัะธัั ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ
docker compose ps

# ะัะพัะผะพัั ะปะพะณะพะฒ
docker compose logs -f

# ะะปะธ ัะตัะตะท Makefile
make ps
make logs
```

ะกะตัะฒะธัั ะดะพัััะฟะฝั ะฟะพ ะฐะดัะตัะฐะผ:
- **Django API**: http://localhost:8000/api/
- **Django Admin**: http://localhost:8000/admin/
- **Telegram Bot**: ะฝะฐะนัะธ ะฑะพัะฐ ะฒ Telegram ะธ ะพัะฟัะฐะฒะธัั `/start`

## ๐ API ะะพะบัะผะตะฝัะฐัะธั

### Authentication

#### POST /api/auth/telegram/
ะะตะณะธัััะฐัะธั/ะฐะฒัะพัะธะทะฐัะธั ัะตัะตะท Telegram ID

**Request:**
```json
{
  "telegram_id": 123456789,
  "telegram_username": "username",
  "first_name": "John",
  "last_name": "Doe"
}
```

**Response:**
```json
{
  "token": "abc123...",
  "user": {
    "id": 1,
    "username": "tg_123456789",
    "telegram_id": 123456789,
    ...
  },
  "created": true
}
```

#### GET /api/auth/me/
ะะพะปััะธัั ะธะฝัะพัะผะฐัะธั ะพ ัะตะบััะตะผ ะฟะพะปัะทะพะฒะฐัะตะปะต (ััะตะฑัะตั ัะพะบะตะฝ)

### Tasks

#### GET /api/tasks/
ะกะฟะธัะพะบ ะทะฐะดะฐั ัะตะบััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั

**Query Parameters:**
- `status` - ัะธะปััั ะฟะพ ััะฐัััั (pending, in_progress, completed, cancelled)
- `category` - ัะธะปััั ะฟะพ ID ะบะฐัะตะณะพัะธะธ

#### POST /api/tasks/
ะกะพะทะดะฐัั ะฝะพะฒัั ะทะฐะดะฐัั

**Request:**
```json
{
  "title": "ะะฐะทะฒะฐะฝะธะต ะทะฐะดะฐัะธ",
  "description": "ะะฟะธัะฐะฝะธะต",
  "deadline": "2024-12-25T14:00:00Z",
  "category_ids": ["01ABC..."]
}
```

#### GET /api/tasks/{id}/
ะะตัะฐะปะธ ะทะฐะดะฐัะธ

#### PATCH /api/tasks/{id}/
ะะฑะฝะพะฒะธัั ะทะฐะดะฐัั

#### DELETE /api/tasks/{id}/
ะฃะดะฐะปะธัั ะทะฐะดะฐัั

#### POST /api/tasks/{id}/complete/
ะัะผะตัะธัั ะทะฐะดะฐัั ะฒัะฟะพะปะฝะตะฝะฝะพะน

#### GET /api/tasks/overdue/
ะัะพััะพัะตะฝะฝัะต ะทะฐะดะฐัะธ

### Categories

#### GET /api/categories/
ะกะฟะธัะพะบ ะบะฐัะตะณะพัะธะน

#### POST /api/categories/
ะกะพะทะดะฐัั ะบะฐัะตะณะพัะธั

**Request:**
```json
{
  "name": "ะะฐะฑะพัะฐ",
  "color": "#FF5733"
}
```

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะะฐะฟััะบ ัะตััะพะฒ
```bash
# ะัะต ัะตััั
docker compose exec backend pytest

# ะก ะฟะพะบัััะธะตะผ ะบะพะดะฐ
docker compose exec backend pytest --cov=apps --cov-report=html

# ะะปะธ ัะตัะตะท Makefile
make test
```

### ะะพะบัััะธะต ะบะพะดะฐ

ะะพัะปะต ะทะฐะฟััะบะฐ ัะตััะพะฒ ะพััะตั ะดะพัััะฟะตะฝ ะฒ `backend/htmlcov/index.html`

**ะขะตะบััะตะต ะฟะพะบัััะธะต: 84%**

## ๐ ะะฐะทัะฐะฑะพัะบะฐ

### ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั (Makefile)
```bash
make help              # ะะพะบะฐะทะฐัั ะฒัะต ะบะพะผะฐะฝะดั
make build             # ะกะพะฑัะฐัั Docker ะพะฑัะฐะทั
make up                # ะะฐะฟัััะธัั ะฒัะต ัะตัะฒะธัั
make down              # ะััะฐะฝะพะฒะธัั ะฒัะต ัะตัะฒะธัั
make restart           # ะะตัะตะทะฐะฟัััะธัั ัะตัะฒะธัั
make logs              # ะะพะณะธ ะฒัะตั ัะตัะฒะธัะพะฒ
make logs-backend      # ะะพะณะธ Django
make logs-celery       # ะะพะณะธ Celery worker
make logs-bot          # ะะพะณะธ Telegram ะฑะพัะฐ
make shell             # Django shell
make bash              # Bash ะฒ ะบะพะฝัะตะนะฝะตัะต backend
make migrate           # ะัะธะผะตะฝะธัั ะผะธะณัะฐัะธะธ
make makemigrations    # ะกะพะทะดะฐัั ะผะธะณัะฐัะธะธ
make test              # ะะฐะฟัััะธัั ัะตััั
make clean             # ะัะธััะธัั ะฒัั (ะบะพะฝัะตะนะฝะตัั, volumes)
make ps                # ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ
```

### ะกัััะบัััะฐ ะฟัะพะตะบัะฐ
```
todo-bot/
โโโ backend/                 # Django ะฟัะธะปะพะถะตะฝะธะต
โ   โโโ apps/
โ   โ   โโโ tasks/          # ะะพะดะตะปะธ ะทะฐะดะฐั ะธ ะบะฐัะตะณะพัะธะน
โ   โ   โ   โโโ models.py   # Task, Category ั ULID PK
โ   โ   โ   โโโ serializers.py
โ   โ   โ   โโโ views.py
โ   โ   โ   โโโ tasks.py    # Celery tasks
โ   โ   โ   โโโ tests/
โ   โ   โโโ users/          # ะะพะดะตะปั ะฟะพะปัะทะพะฒะฐัะตะปั
โ   โ       โโโ models.py   # User ั telegram_id
โ   โ       โโโ views.py    # Auth endpoints
โ   โ       โโโ tests/
โ   โโโ config/             # ะะฐัััะพะนะบะธ Django
โ   โ   โโโ settings.py
โ   โ   โโโ celery.py
โ   โ   โโโ urls.py
โ   โโโ Dockerfile
โ   โโโ requirements.txt
โ   โโโ manage.py
โโโ bot/                    # Telegram ะฑะพั
โ   โโโ handlers/           # ะะฑัะฐะฑะพััะธะบะธ ะบะพะผะฐะฝะด
โ   โ   โโโ start.py
โ   โ   โโโ tasks.py
โ   โ   โโโ create_task.py
โ   โ   โโโ categories.py
โ   โโโ services/
โ   โ   โโโ api_client.py   # HTTP ะบะปะธะตะฝั ะดะปั API
โ   โ   โโโ token_storage.py
โ   โโโ middlewares/
โ   โ   โโโ auth.py         # ะะฒัะพะผะฐัะธัะตัะบะฐั ัะตะณะธัััะฐัะธั
โ   โโโ config.py
โ   โโโ main.py
โ   โโโ Dockerfile
โ   โโโ requirements.txt
โโโ docker compose.yml
โโโ Makefile
โโโ .env.example
โโโ .gitignore
โโโ README.md
```

## ๐จ ะัะพะฑะตะฝะฝะพััะธ ัะตะฐะปะธะทะฐัะธะธ

### 1. ะะฐััะพะผะฝัะต Primary Keys (ULID)

ะะผะตััะพ ััะฐะฝะดะฐััะฝัั UUID ะธะปะธ ะฐะฒัะพะธะฝะบัะตะผะตะฝัะฐ ะธัะฟะพะปัะทััััั ULID:
- โ ะะตะบัะธะบะพะณัะฐัะธัะตัะบะธ ัะพััะธััะตะผัะต
- โ Timestamp ะฒ ะฝะฐัะฐะปะต ID
- โ ะะตะท ะบะพะปะปะธะทะธะน ะฒ ัะฐัะฟัะตะดะตะปัะฝะฝะพะน ัะธััะตะผะต
- โ 26 ัะธะผะฒะพะปะพะฒ (ะบะพัะพัะต UUID)
```python
class ULIDField(models.CharField):
    def __init__(self, *args, **kwargs):
        kwargs['max_length'] = 26
        kwargs['primary_key'] = True
        super().__init__(*args, **kwargs)
    
    def pre_save(self, model_instance, add):
        if add and not getattr(model_instance, self.attname):
            value = str(ULID())
            setattr(model_instance, self.attname, value)
            return value
        return super().pre_save(model_instance, add)
```

### 2. Timezone Management

ะัะต ะดะฐัั ััะฐะฝัััั ะฒ UTC, ะฝะพ ะพัะพะฑัะฐะถะฐัััั ะฒ timezone America/Adak:
```python
TIME_ZONE = 'America/Adak'  # UTC-10/-9
USE_TZ = True
```

### 3. Celery ะดะปั ัะฒะตะดะพะผะปะตะฝะธะน

Celery Beat ะฟัะพะฒะตััะตั ะดะตะดะปะฐะนะฝั ะบะฐะถะดัะต 5 ะผะธะฝัั:
```python
app.conf.beat_schedule = {
    'check-task-deadlines': {
        'task': 'apps.tasks.tasks.check_task_deadlines',
        'schedule': crontab(minute='*/5'),
    },
}
```

### 4. FSM ะฒ Telegram ะฑะพัะต

ะะฝะพะณะพัะฐะณะพะฒัะน ะฟัะพัะตัั ัะพะทะดะฐะฝะธั ะทะฐะดะฐัะธ ัะตัะตะท Finite State Machine:
```python
class CreateTaskStates(StatesGroup):
    waiting_for_title = State()
    waiting_for_description = State()
    waiting_for_deadline = State()
    waiting_for_category = State()
```

## ๐ ะะตััะฝะฝัะต ะฟัะพะฑะปะตะผั

### ะัะพะฑะปะตะผะฐ 1: PostgreSQL permissions ะดะปั ัะตััะพะฒ
**ะะตัะตะฝะธะต:** ะะฐัั ะฟัะฐะฒะฐ CREATEDB ะฟะพะปัะทะพะฒะฐัะตะปั ะะ
```sql
ALTER USER todo_user CREATEDB;
```

### ะัะพะฑะปะตะผะฐ 2: Format_html ะฒ Django 6.0
**ะะตัะตะฝะธะต:** ะัะฟะพะปัะทะพะฒะฐัั `mark_safe` ะฒะผะตััะพ `format_html` ะฑะตะท ะฐัะณัะผะตะฝัะพะฒ
```python
from django.utils.safestring import mark_safe
return mark_safe('<span style="color: red;">Text</span>')
```

### ะัะพะฑะปะตะผะฐ 3: Celery ะฝะต ะผะพะถะตั ะพัะฟัะฐะฒะธัั ัะฒะตะดะพะผะปะตะฝะธั
**ะะตัะตะฝะธะต:** 
- ะะพะปัะทะพะฒะฐัะตะปั ะดะพะปะถะตะฝ ัะฝะฐัะฐะปะฐ ะฝะฐะฟะธัะฐัั `/start` ะฑะพัั
- ะัะพะฒะตัะบะฐ ะฒะฐะปะธะดะฝะพััะธ telegram_id ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน
- ะะฑัะฐะฑะพัะบะฐ 400/403/404 ะพัะธะฑะพะบ ะฑะตะท retry

## ๐ TODO / ะะพะทะผะพะถะฝัะต ัะปัััะตะฝะธั

- [ ] Webhook ัะตะถะธะผ ะดะปั ะฑะพัะฐ ะฒะผะตััะพ polling
- [ ] Persistent storage ะดะปั ัะพะบะตะฝะพะฒ (Redis/DB)
- [ ] Aiogram-dialog ะดะปั ะฑะพะปะตะต ัะปะพะถะฝัั ะดะธะฐะปะพะณะพะฒ
- [ ] ะะฐะฟะพะผะธะฝะฐะฝะธั ะทะฐ N ัะฐัะพะฒ ะดะพ ะดะตะดะปะฐะนะฝะฐ (ะฝะฐัััะฐะธะฒะฐะตะผัะต)
- [ ] ะญะบัะฟะพัั ะทะฐะดะฐั ะฒ CSV/PDF
- [ ] ะกัะฐัะธััะธะบะฐ ะฟะพ ะฒัะฟะพะปะฝะตะฝะฝัะผ ะทะฐะดะฐัะฐะผ
- [ ] Shared tasks (ัะพะฒะผะตััะฝัะต ะทะฐะดะฐัะธ)
- [ ] ะะพะดะทะฐะดะฐัะธ (subtasks)
- [ ] ะัะธะพัะธัะตัั ะทะฐะดะฐั
- [ ] ะขะตะณะธ ะดะปั ะทะฐะดะฐั
- [ ] ะะพะธัะบ ะฟะพ ะทะฐะดะฐัะฐะผ

## ๐ ะะธัะตะฝะทะธั

MIT License

## ๐ค ะะฒัะพั

ะะฐะทัะฐะฑะพัะฐะฝะพ ะบะฐะบ ัะตััะพะฒะพะต ะทะฐะดะฐะฝะธะต ะดะปั ะฟะพะทะธัะธะธ Backend ัะฐะทัะฐะฑะพััะธะบะฐ

---

## ๐ Troubleshooting

### ะะพะฝัะตะนะฝะตัั ะฝะต ะทะฐะฟััะบะฐัััั
```bash
docker compose down -v
docker compose build --no-cache
docker compose up -d
```

### ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะต ัะพะทะดะฐัััั
```bash
docker compose down -v
docker volume prune
docker compose up -d
```

### ะะพั ะฝะต ะพัะฒะตัะฐะตั
1. ะัะพะฒะตัะธัั ัะพะบะตะฝ ะฒ `.env`
2. ะัะพะฒะตัะธัั ะปะพะณะธ: `docker compose logs bot`
3. ะัะพะฒะตัะธัั ััะพ backend ะดะพัััะฟะตะฝ: `curl http://localhost:8000/api/categories/`

### Celery ะฝะต ัะฐะฑะพัะฐะตั
```bash
# ะัะพะฒะตัะธัั Redis
docker compose exec redis redis-cli ping

# ะัะพะฒะตัะธัั ะปะพะณะธ
docker compose logs celery_worker
docker compose logs celery_beat
```

### ะขะตััั ะฟะฐะดะฐัั
```bash
# ะะฐัั ะฟัะฐะฒะฐ ะฝะฐ ัะพะทะดะฐะฝะธะต ัะตััะพะฒะพะน ะะ
docker compose exec db psql -U todo_user -d postgres -c "ALTER USER todo_user CREATEDB;"

# ะะฐะฟัััะธัั ัะตััั ัะฝะพะฒะฐ
make test
```